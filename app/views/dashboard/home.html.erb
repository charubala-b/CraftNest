<meta name="current-user-id" content="<%= current_user.id %>">
<meta name="csrf-token" content="<%= form_authenticity_token %>">

<%= stylesheet_link_tag "dashboard", media: "all", "data-turbo-track": "reload" %>

<!-- Flash Messages -->
<div id="flash-messages" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
  <% flash.each do |key, message| %>
    <div class="alert alert-<%= key == "notice" ? "success" : "danger" %> alert-dismissible fade show" role="alert">
      <%= message %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>
</div>

<div class="dashboard-container">
  <h1 class="dashboard-title">Client Dashboard</h1>

  <!-- Tabs -->
  <div class="dashboard-tabs">
    <button class="tab-button active" onclick="openTab(event, 'projects')">Projects</button>
    <button class="tab-button" onclick="openTab(event, 'contracts')">Contracts</button>
    <button class="tab-button" onclick="openTab(event, 'messages')">Messages</button>
    <button class="tab-button" onclick="openTab(event, 'completed_projects')">Completed Projects</button>
  </div>

  <!-- Projects Tab -->
  <div id="projects" class="tab-content" style="display: block;">
    <!-- your project content -->
  </div>

  <!-- Contracts Tab -->
  <div id="contracts" class="tab-content">
    <% @contracts.each do |contract| %>
      <div class="contract-card">
        <p><strong>Project:</strong> <%= contract.project.title %></p>
        <p><strong>Freelancer:</strong> <%= contract.freelancer.name %></p>
        <p><strong>Status:</strong> <%= contract.status.humanize %></p>

        <% if contract.completed? %>
          <div class="review-section">
            <!-- Client Review -->
            <h5>Client's Review for Freelancer</h5>
            <% client_review = contract.project.reviews.find_by(reviewer_id: contract.client_id) %>
            <% if client_review.present? %>
              <div class="review-card">
                <p>⭐ <%= client_review.ratings %> - <%= client_review.review %></p>
                <p><em>by <%= contract.client.name %></em></p>
              </div>
            <% else %>
              <% if current_user.id == contract.client_id %>
                <div id="client-review-section-<%= contract.id %>" data-reviewee-id="<%= contract.freelancer_id %>" data-project-id="<%= contract.project_id %>" data-reviewer-id="<%= current_user.id %>"></div>
              <% end %>
            <% end %>

            <!-- Freelancer Review -->
            <h5>Freelancer's Review for Client</h5>
            <% freelancer_review = contract.project.reviews.find_by(reviewer_id: contract.freelancer_id) %>
            <% if freelancer_review.present? %>
              <div class="review-card">
                <p>⭐ <%= freelancer_review.ratings %> - <%= freelancer_review.review %></p>
                <p><em>by <%= contract.freelancer.name %></em></p>
              </div>
            <% else %>
              <% if current_user.id == contract.freelancer_id %>
                <div id="freelancer-review-section-<%= contract.id %>" data-reviewee-id="<%= contract.client_id %>" data-project-id="<%= contract.project_id %>" data-reviewer-id="<%= current_user.id %>"></div>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <%= form_with url: contract_path(contract), method: :patch, local: true, data: { turbo: false } do |f| %>
            <%= hidden_field_tag "contract[status]", "completed" %>
            <%= f.submit "Mark Complete", class: "btn btn-warning", data: { confirm: "Are you sure?" } %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Messages Tab -->
  <div id="messages" class="tab-content">
    <!-- your messages -->
  </div>

  <!-- Completed Projects Tab -->
  <div id="completed_projects" class="tab-content">
    <% @completed_projects.each do |project| %>
      <div class="project-card completed-card">
        <h3><%= project.title %></h3>
        <p><%= project.description %></p>
        <p><strong>Budget:</strong> ₹<%= project.budget %></p>
        <p><strong>Deadline:</strong> <%= project.deadline.strftime("%d %b %Y") %></p>
      </div>
    <% end %>
  </div>
</div>

<!-- JavaScript -->
<script>
  function openTab(evt, tabId) {
    document.querySelectorAll(".tab-content").forEach(el => el.style.display = "none");
    document.querySelectorAll(".tab-button").forEach(el => el.classList.remove("active"));
    document.getElementById(tabId).style.display = "block";
    evt.currentTarget.classList.add("active");
  }

  document.addEventListener("DOMContentLoaded", () => {
    const currentUserId = document.querySelector('meta[name="current-user-id"]').content;
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    document.querySelectorAll("[id^='client-review-section-'], [id^='freelancer-review-section-']").forEach(section => {
      const projectId = section.dataset.projectId;
      const reviewerId = section.dataset.reviewerId;
      const revieweeId = section.dataset.revieweeId;

      fetch(`/api/v1/reviews/${projectId}/${reviewerId}`)
        .then(res => res.json().catch(() => ({ message: "Invalid JSON" })))
        .then(data => {
          if (data && data.id) {
            section.innerHTML = `
              <div class="review-card">
                <p>⭐ ${data.ratings} - ${data.review}</p>
                <p><em>by you</em></p>
              </div>
            `;
          } else if (data.message === "Review not found") {
            section.innerHTML = `
              <form onsubmit="submitReview(event, ${projectId}, ${revieweeId})">
                <label>Rating (1-5):</label>
                <input type="number" name="ratings" min="1" max="5" required><br>
                <label>Review:</label>
                <textarea name="review" minlength="10" maxlength="100" required></textarea><br>
                <button type="submit" class="btn btn-sm btn-warning">Submit Review</button>
              </form>
              <div class="review-message"></div>
            `;
          } else {
            section.innerHTML = `<p style="color:red;">Unable to load review or form.</p>`;
          }
        });
    });

    // Flash message auto-close
    const alert = document.querySelector('.alert');
    if (alert) {
      setTimeout(() => alert.remove(), 3000);
    }
  });

  function submitReview(e, projectId, revieweeId) {
  e.preventDefault();
  const form = e.target;
  const messageEl = form.nextElementSibling;
  const ratings = form.ratings.value;
  const reviewText = form.review.value;

  form.querySelector("button").disabled = true;

  fetch('/api/v1/reviews', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    },
    body: JSON.stringify({
      review: {
        ratings: ratings,
        review: reviewText,
        project_id: projectId,
        reviewee_id: revieweeId
      }
    })
  })
  .then(res => {
    if (!res.ok) {
      return res.json().then(data => Promise.reject(data));
    }
    return res.json(); // review created
  })
  .then(() => {
    location.reload(); // ✅ reload page after success
  })
  .catch(err => {
    const errorMessage = err.errors ? err.errors.join(', ') : err.message || 'Something went wrong';
    messageEl.innerHTML = `<p style="color:red;">${errorMessage}</p>`;
    form.querySelector("button").disabled = false;
  });
}

</script>